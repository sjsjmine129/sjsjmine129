# Layer : npm_for_tikkle [7/27]

## 포함 사항

npm :  dotenv aws-sdk moment jsonwebtoken mysql2
예시 →  const jwt = require("jsonwebtoken");

- ssm.js : 환경변수 접근
    
    
    | import  |  const { getSSMParameter } = require("ssm.js"); |
    | --- | --- |
    | input | input   |
    | output | 값 존재시 반환, 없으면 null |

- token.js : 토큰 확인 & 재발급
    
    
    | import  |  const { checkToken } = require("token.js"); |
    | --- | --- |
    | input | accessToken, refreshToken   |
    | output | refresh 토큰 만료 or 토큰 없음 or 토큰 오류  :  401  → 다시 로그인
    성공시 : 200 → accessToken : 만료시 재발급, 만료 x시  null
                             tokenData : token decoding 한 데이터 |
    
    ```jsx
    const returnBody = JSON.stringify({
    		accessToken: ReturnToken,
    		tokenData: tokenData,
    	});
    
    	return {
    		statusCode: 200,
    		body: returnBody,
    	};
    ```
    

- db.js: db로 connection후 쿼리 전송, 끝난뒤에 연결 해제
    
    
    | import  |  const { queryDatabase } = require("db.js"); |
    | --- | --- |
    | input | sql, parameter          
    
    ex)queryDatabase("select * from users where name = ?", ["최영섭"]); |
    | output | 해당 쿼리의 결과를 list로 반환      
    
    ex:
    [
    {
    "id": 2,
    "name": "최영섭",
    "birthday": "1999-12-14T00:00:00.000Z",
    "nick": "sup1214",
    "phone": "01053783514",
    "is_deleted": 0,
    "gender": "male",
    "image": null,
    "address": null,
    "detail_address": null,
    "created_at": "2023-07-26T05:04:50.000Z",
    "is_tikkling": 0
    }
    ]
    
     |
    |  |  |
    
    ```jsx
    const mysql = require("mysql2/promise");
    const { getSSMParameter } = require("ssm.js");
    
    async function getDatabaseCredentials() {
      const host = await getSSMParameter("MYSQL_HOST");
      const user = await getSSMParameter("MYSQL_USER");
      const password = await getSSMParameter("MYSQL_PASSWORD");
      const database = await getSSMParameter("MYSQL_DATABASE");
    
      return { host, user, password, database };
    }
    
    async function queryDatabase(sql, params) {
      const credentials = await getDatabaseCredentials();
      const connection = await mysql.createConnection(credentials);
      const [rows] = await connection.execute(sql, params);
      
      // 사용이 끝난 연결 종료.
      await connection.end();
    
      return rows;
    }
    
    exports.queryDatabase = queryDatabase;
    ```